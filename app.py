
import os
import json
import re
from flask import Flask, request, jsonify
from flask_cors import CORS
from thefuzz import process

app = Flask(__name__)
CORS(app)

with open("routes.json", "r", encoding="utf-8") as f:
    routes = json.load(f)

CITY_FORMS = {
  "–±–∞–±–∞–Ω–∫–∞": [
    "–±–∞–±–∞–Ω–∫",
    "–±–∞–±–∞–Ω–∫–∞",
    "–±–∞–±–∞–Ω–∫–æ—é",
    "–±–∞–±–∞–Ω–∫—É",
    "–±–∞–±–∞–Ω–∫—ñ"
  ],
  "–±–∞—à—Ç–∞–Ω–∫–∞": [
    "–±–∞—à—Ç–∞–Ω–∫",
    "–±–∞—à—Ç–∞–Ω–∫–∞",
    "–±–∞—à—Ç–∞–Ω–∫–æ—é",
    "–±–∞—à—Ç–∞–Ω–∫—É",
    "–±–∞—à—Ç–∞–Ω–∫—ñ"
  ],
  "–±–æ—Ä–∏—Å–ø—ñ–ª—å": [
    "–±–æ—Ä–∏—Å–ø—ñ–ª—å",
    "–±–æ—Ä–∏—Å–ø—ñ–ª—å–∞",
    "–±–æ—Ä–∏—Å–ø—ñ–ª—å–µ",
    "–±–æ—Ä–∏—Å–ø—ñ–ª—å–æ–º",
    "–±–æ—Ä–∏—Å–ø—ñ–ª—å—É"
  ],
  "–≤–µ–ª–∏–∫–∞ –≤–∏—Å–∫–∞": [
    "–≤–µ–ª–∏–∫–∞ –≤–∏—Å–∫",
    "–≤–µ–ª–∏–∫–∞ –≤–∏—Å–∫–∞",
    "–≤–µ–ª–∏–∫–∞ –≤–∏—Å–∫–æ—é",
    "–≤–µ–ª–∏–∫–∞ –≤–∏—Å–∫—É",
    "–≤–µ–ª–∏–∫–∞ –≤–∏—Å–∫—ñ"
  ],
  "–≤–æ—Ä–æ–Ω–æ–≤–∏—Ü—è": [
    "–≤–æ—Ä–æ–Ω–æ–≤–∏—Ü—é",
    "–≤–æ—Ä–æ–Ω–æ–≤–∏—Ü—è",
    "–≤–æ—Ä–æ–Ω–æ–≤–∏—Ü—ñ"
  ],
  "–≤—ñ–Ω–Ω–∏—Ü—è": [
    "–≤—ñ–Ω–Ω–∏—Ü—é",
    "–≤—ñ–Ω–Ω–∏—Ü—è",
    "–≤—ñ–Ω–Ω–∏—Ü—ñ"
  ],
  "–≥–∞–π—Å–∏–Ω": [
    "–≥–∞–π—Å–∏–Ω",
    "–≥–∞–π—Å–∏–Ω–∞",
    "–≥–∞–π—Å–∏–Ω–µ",
    "–≥–∞–π—Å–∏–Ω–æ–º",
    "–≥–∞–π—Å–∏–Ω—É"
  ],
  "–≥—Ä–∏—à–∏–Ω–µ": [
    "–≥—Ä–∏—à–∏–Ω–µ",
    "–≥—Ä–∏—à–∏–Ω–µ–∞",
    "–≥—Ä–∏—à–∏–Ω–µ–µ",
    "–≥—Ä–∏—à–∏–Ω–µ–æ–º",
    "–≥—Ä–∏—à–∏–Ω–µ—É"
  ],
  "–¥–Ω—ñ–ø—Ä–æ": [
    "–¥–Ω—ñ–ø—Ä–∞",
    "–¥–Ω—ñ–ø—Ä–æ",
    "–¥–Ω—ñ–ø—Ä—É"
  ],
  "–¥–æ–±—Ä–æ–ø—ñ–ª–ª—è": [
    "–¥–æ–±—Ä–æ–ø—ñ–ª–ª—é",
    "–¥–æ–±—Ä–æ–ø—ñ–ª–ª—è",
    "–¥–æ–±—Ä–æ–ø—ñ–ª–ª—ñ"
  ],
  "–¥—Ä—É–∂–∫—ñ–≤–∫–∞": [
    "–¥—Ä—É–∂–∫—ñ–≤–∫",
    "–¥—Ä—É–∂–∫—ñ–≤–∫–∞",
    "–¥—Ä—É–∂–∫—ñ–≤–∫–æ—é",
    "–¥—Ä—É–∂–∫—ñ–≤–∫—É",
    "–¥—Ä—É–∂–∫—ñ–≤–∫—ñ"
  ],
  "–∂–∏—Ç–æ–º–∏—Ä": [
    "–∂–∏—Ç–æ–º–∏—Ä",
    "–∂–∏—Ç–æ–º–∏—Ä–∞",
    "–∂–∏—Ç–æ–º–∏—Ä–µ",
    "–∂–∏—Ç–æ–º–∏—Ä–æ–º",
    "–∂–∏—Ç–æ–º–∏—Ä—É"
  ],
  "–∑–∞–ø–æ—Ä—ñ–∂–∂—è": [
    "–∑–∞–ø–æ—Ä—ñ–∂–∂—é",
    "–∑–∞–ø–æ—Ä—ñ–∂–∂—è",
    "–∑–∞–ø–æ—Ä—ñ–∂–∂—ñ"
  ],
  "–∑–Ω–∞–º'—è–Ω–∫–∞": [
    "–∑–Ω–∞–º'—è–Ω–∫",
    "–∑–Ω–∞–º'—è–Ω–∫–∞",
    "–∑–Ω–∞–º'—è–Ω–∫–æ—é",
    "–∑–Ω–∞–º'—è–Ω–∫—É",
    "–∑–Ω–∞–º'—è–Ω–∫—ñ"
  ],
  "–∑–æ–ª–æ—Ç–æ–Ω–æ—à–∞": [
    "–∑–æ–ª–æ—Ç–æ–Ω–æ—à",
    "–∑–æ–ª–æ—Ç–æ–Ω–æ—à–∞",
    "–∑–æ–ª–æ—Ç–æ–Ω–æ—à–æ—é",
    "–∑–æ–ª–æ—Ç–æ–Ω–æ—à—É",
    "–∑–æ–ª–æ—Ç–æ–Ω–æ—à—ñ"
  ],
  "–∫–∞–∑–∞–Ω–∫–∞": [
    "–∫–∞–∑–∞–Ω–∫",
    "–∫–∞–∑–∞–Ω–∫–∞",
    "–∫–∞–∑–∞–Ω–∫–æ—é",
    "–∫–∞–∑–∞–Ω–∫—É",
    "–∫–∞–∑–∞–Ω–∫—ñ"
  ],
  "–∫–∞–º'—è–Ω–∫–∞": [
    "–∫–∞–º'—è–Ω–∫",
    "–∫–∞–º'—è–Ω–∫–∞",
    "–∫–∞–º'—è–Ω–∫–æ—é",
    "–∫–∞–º'—è–Ω–∫—É",
    "–∫–∞–º'—è–Ω–∫—ñ"
  ],
  "–∫–∞–Ω—ñ–≤": [
    "–∫–∞–Ω—ñ–≤",
    "–∫–∞–Ω—ñ–≤–∞",
    "–∫–∞–Ω—ñ–≤–µ",
    "–∫–∞–Ω—ñ–≤–æ–º",
    "–∫–∞–Ω—ñ–≤—É"
  ],
  "–∫–∞—Ä–ª—ñ–≤–∫–∞": [
    "–∫–∞—Ä–ª—ñ–≤–∫",
    "–∫–∞—Ä–ª—ñ–≤–∫–∞",
    "–∫–∞—Ä–ª—ñ–≤–∫–æ—é",
    "–∫–∞—Ä–ª—ñ–≤–∫—É",
    "–∫–∞—Ä–ª—ñ–≤–∫—ñ"
  ],
  "–∫–∏—ó–≤": [
    "–∫–∏—ó–≤",
    "–∫–∏—ó–≤–∞",
    "–∫–∏—ó–≤–µ",
    "–∫–∏—ó–≤–æ–º",
    "–∫–∏—ó–≤—É"
  ],
  "–∫–æ–±–ª–µ–≤–æ": [
    "–∫–æ–±–ª–µ–≤–∞",
    "–∫–æ–±–ª–µ–≤–æ",
    "–∫–æ–±–ª–µ–≤—É"
  ],
  "–∫—Ä–∞–º–∞—Ç–æ—Ä—Å—å–∫": [
    "–∫—Ä–∞–º–∞—Ç–æ—Ä—Å—å–∫",
    "–∫—Ä–∞–º–∞—Ç–æ—Ä—Å—å–∫–∞",
    "–∫—Ä–∞–º–∞—Ç–æ—Ä—Å—å–∫–µ",
    "–∫—Ä–∞–º–∞—Ç–æ—Ä—Å—å–∫–æ–º",
    "–∫—Ä–∞–º–∞—Ç–æ—Ä—Å—å–∫—É"
  ],
  "–∫—Ä–∞—Å–Ω–æ–≥—Ä–∞–¥": [
    "–∫—Ä–∞—Å–Ω–æ–≥—Ä–∞–¥",
    "–∫—Ä–∞—Å–Ω–æ–≥—Ä–∞–¥–∞",
    "–∫—Ä–∞—Å–Ω–æ–≥—Ä–∞–¥–µ",
    "–∫—Ä–∞—Å–Ω–æ–≥—Ä–∞–¥–æ–º",
    "–∫—Ä–∞—Å–Ω–æ–≥—Ä–∞–¥—É"
  ],
  "–∫—Ä–∞—Å–Ω–æ–ø—ñ–ª–∫–∞": [
    "–∫—Ä–∞—Å–Ω–æ–ø—ñ–ª–∫",
    "–∫—Ä–∞—Å–Ω–æ–ø—ñ–ª–∫–∞",
    "–∫—Ä–∞—Å–Ω–æ–ø—ñ–ª–∫–æ—é",
    "–∫—Ä–∞—Å–Ω–æ–ø—ñ–ª–∫—É",
    "–∫—Ä–∞—Å–Ω–æ–ø—ñ–ª–∫—ñ"
  ],
  "–∫—Ä–∏–≤–∏–π —Ä—ñ–≥": [
    "–∫—Ä–∏–≤–∏–π —Ä—ñ–≥",
    "–∫—Ä–∏–≤–∏–π —Ä—ñ–≥–∞",
    "–∫—Ä–∏–≤–∏–π —Ä—ñ–≥–µ",
    "–∫—Ä–∏–≤–∏–π —Ä—ñ–≥–æ–º",
    "–∫—Ä–∏–≤–∏–π —Ä—ñ–≥—É"
  ],
  "–∫—Ä–æ–ø–∏–≤–Ω–∏—Ü—å–∫–∏–π": [
    "–∫—Ä–æ–ø–∏–≤–Ω–∏—Ü—å–∫–∏–π",
    "–∫—Ä–æ–ø–∏–≤–Ω–∏—Ü—å–∫–∏–π–∞",
    "–∫—Ä–æ–ø–∏–≤–Ω–∏—Ü—å–∫–∏–π–µ",
    "–∫—Ä–æ–ø–∏–≤–Ω–∏—Ü—å–∫–∏–π–æ–º",
    "–∫—Ä–æ–ø–∏–≤–Ω–∏—Ü—å–∫–∏–π—É"
  ],
  "–ª—É–±–Ω–∏": [
    "–ª—É–±–Ω–∏",
    "–ª—É–±–Ω–∏–∞",
    "–ª—É–±–Ω–∏–µ",
    "–ª—É–±–Ω–∏–æ–º",
    "–ª—É–±–Ω–∏—É"
  ],
  "–ª—å–≤—ñ–≤": [
    "–ª—å–≤—ñ–≤",
    "–ª—å–≤—ñ–≤–∞",
    "–ª—å–≤—ñ–≤–µ",
    "–ª—å–≤—ñ–≤–æ–º",
    "–ª—å–≤—ñ–≤—É"
  ],
  "–º–µ–∂–æ–≤–∞": [
    "–º–µ–∂–æ–≤",
    "–º–µ–∂–æ–≤–∞",
    "–º–µ–∂–æ–≤–æ—é",
    "–º–µ–∂–æ–≤—É",
    "–º–µ–∂–æ–≤—ñ"
  ],
  "–º–∏–∫–æ–ª–∞—ó–≤": [
    "–º–∏–∫–æ–ª–∞—ó–≤",
    "–º–∏–∫–æ–ª–∞—ó–≤–∞",
    "–º–∏–∫–æ–ª–∞—ó–≤–µ",
    "–º–∏–∫–æ–ª–∞—ó–≤–æ–º",
    "–º–∏–∫–æ–ª–∞—ó–≤—É"
  ],
  "–º–∏–∫–æ–ª–∞—ó–≤–∫–∞": [
    "–º–∏–∫–æ–ª–∞—ó–≤–∫",
    "–º–∏–∫–æ–ª–∞—ó–≤–∫–∞",
    "–º–∏–∫–æ–ª–∞—ó–≤–∫–æ—é",
    "–º–∏–∫–æ–ª–∞—ó–≤–∫—É",
    "–º–∏–∫–æ–ª–∞—ó–≤–∫—ñ"
  ],
  "–Ω–µ–º–∏—Ä—ñ–≤": [
    "–Ω–µ–º–∏—Ä—ñ–≤",
    "–Ω–µ–º–∏—Ä—ñ–≤–∞",
    "–Ω–µ–º–∏—Ä—ñ–≤–µ",
    "–Ω–µ–º–∏—Ä—ñ–≤–æ–º",
    "–Ω–µ–º–∏—Ä—ñ–≤—É"
  ],
  "–Ω–æ–≤–∏–π –±—É–≥": [
    "–Ω–æ–≤–∏–π –±—É–≥",
    "–Ω–æ–≤–∏–π –±—É–≥–∞",
    "–Ω–æ–≤–∏–π –±—É–≥–µ",
    "–Ω–æ–≤–∏–π –±—É–≥–æ–º",
    "–Ω–æ–≤–∏–π –±—É–≥—É"
  ],
  "–Ω–æ–≤–æ–∞—Ä—Ö–∞–Ω–≥–µ–ª—å—Å–∫": [
    "–Ω–æ–≤–æ–∞—Ä—Ö–∞–Ω–≥–µ–ª—å—Å–∫",
    "–Ω–æ–≤–æ–∞—Ä—Ö–∞–Ω–≥–µ–ª—å—Å–∫–∞",
    "–Ω–æ–≤–æ–∞—Ä—Ö–∞–Ω–≥–µ–ª—å—Å–∫–µ",
    "–Ω–æ–≤–æ–∞—Ä—Ö–∞–Ω–≥–µ–ª—å—Å–∫–æ–º",
    "–Ω–æ–≤–æ–∞—Ä—Ö–∞–Ω–≥–µ–ª—å—Å–∫—É"
  ],
  "–Ω–æ–≤–æ–º–æ—Å–∫–æ–≤—Å—å–∫ (—Å–∞–º–∞—Ä)": [
    "–Ω–æ–≤–æ–º–æ—Å–∫–æ–≤—Å—å–∫ (—Å–∞–º–∞—Ä)",
    "–Ω–æ–≤–æ–º–æ—Å–∫–æ–≤—Å—å–∫ (—Å–∞–º–∞—Ä)–∞",
    "–Ω–æ–≤–æ–º–æ—Å–∫–æ–≤—Å—å–∫ (—Å–∞–º–∞—Ä)–µ",
    "–Ω–æ–≤–æ–º–æ—Å–∫–æ–≤—Å—å–∫ (—Å–∞–º–∞—Ä)–æ–º",
    "–Ω–æ–≤–æ–º–æ—Å–∫–æ–≤—Å—å–∫ (—Å–∞–º–∞—Ä)—É"
  ],
  "–æ–¥–µ—Å–∞": [
    "–æ–¥–µ—Å",
    "–æ–¥–µ—Å–∞",
    "–æ–¥–µ—Å–æ—é",
    "–æ–¥–µ—Å—É",
    "–æ–¥–µ—Å—ñ"
  ],
  "–æ–ª–µ–∫—Å–∞–Ω–¥—Ä—ñ–≤–∫–∞": [
    "–æ–ª–µ–∫—Å–∞–Ω–¥—Ä—ñ–≤–∫",
    "–æ–ª–µ–∫—Å–∞–Ω–¥—Ä—ñ–≤–∫–∞",
    "–æ–ª–µ–∫—Å–∞–Ω–¥—Ä—ñ–≤–∫–æ—é",
    "–æ–ª–µ–∫—Å–∞–Ω–¥—Ä—ñ–≤–∫—É",
    "–æ–ª–µ–∫—Å–∞–Ω–¥—Ä—ñ–≤–∫—ñ"
  ],
  "–æ–ª–µ–∫—Å–∞–Ω–¥—Ä—ñ—è": [
    "–æ–ª–µ–∫—Å–∞–Ω–¥—Ä—ñ—é",
    "–æ–ª–µ–∫—Å–∞–Ω–¥—Ä—ñ—è",
    "–æ–ª–µ–∫—Å–∞–Ω–¥—Ä—ñ—ñ"
  ],
  "–æ—Ä–∞–¥—ñ–≤–∫–∞": [
    "–æ—Ä–∞–¥—ñ–≤–∫",
    "–æ—Ä–∞–¥—ñ–≤–∫–∞",
    "–æ—Ä–∞–¥—ñ–≤–∫–æ—é",
    "–æ—Ä–∞–¥—ñ–≤–∫—É",
    "–æ—Ä–∞–¥—ñ–≤–∫—ñ"
  ],
  "–ø'—è—Ç–∏—Ö–∞—Ç–∫–∏": [
    "–ø'—è—Ç–∏—Ö–∞—Ç–∫–∏",
    "–ø'—è—Ç–∏—Ö–∞—Ç–∫–∏–∞",
    "–ø'—è—Ç–∏—Ö–∞—Ç–∫–∏–µ",
    "–ø'—è—Ç–∏—Ö–∞—Ç–∫–∏–æ–º",
    "–ø'—è—Ç–∏—Ö–∞—Ç–∫–∏—É"
  ],
  "–ø–∞–≤–ª–æ–≥—Ä–∞–¥": [
    "–ø–∞–≤–ª–æ–≥—Ä–∞–¥",
    "–ø–∞–≤–ª–æ–≥—Ä–∞–¥–∞",
    "–ø–∞–≤–ª–æ–≥—Ä–∞–¥–µ",
    "–ø–∞–≤–ª–æ–≥—Ä–∞–¥–æ–º",
    "–ø–∞–≤–ª–æ–≥—Ä–∞–¥—É"
  ],
  "–ø–∏—Ä—è—Ç–∏–Ω": [
    "–ø–∏—Ä—è—Ç–∏–Ω",
    "–ø–∏—Ä—è—Ç–∏–Ω–∞",
    "–ø–∏—Ä—è—Ç–∏–Ω–µ",
    "–ø–∏—Ä—è—Ç–∏–Ω–æ–º",
    "–ø–∏—Ä—è—Ç–∏–Ω—É"
  ],
  "–ø–æ–∫—Ä–æ–≤—Å—å–∫": [
    "–ø–æ–∫—Ä–æ–≤—Å—å–∫",
    "–ø–æ–∫—Ä–æ–≤—Å—å–∫–∞",
    "–ø–æ–∫—Ä–æ–≤—Å—å–∫–µ",
    "–ø–æ–∫—Ä–æ–≤—Å—å–∫–æ–º",
    "–ø–æ–∫—Ä–æ–≤—Å—å–∫—É"
  ],
  "–ø–æ–ª—Ç–∞–≤–∞": [
    "–ø–æ–ª—Ç–∞–≤",
    "–ø–æ–ª—Ç–∞–≤–∞",
    "–ø–æ–ª—Ç–∞–≤–æ—é",
    "–ø–æ–ª—Ç–∞–≤—É",
    "–ø–æ–ª—Ç–∞–≤—ñ"
  ],
  "—Ä–∞–π–≥–æ—Ä–æ–¥": [
    "—Ä–∞–π–≥–æ—Ä–æ–¥",
    "—Ä–∞–π–≥–æ—Ä–æ–¥–∞",
    "—Ä–∞–π–≥–æ—Ä–æ–¥–µ",
    "—Ä–∞–π–≥–æ—Ä–æ–¥–æ–º",
    "—Ä–∞–π–≥–æ—Ä–æ–¥—É"
  ],
  "—Ä–µ—à–∏—Ç–∏–ª—ñ–≤–∫–∞": [
    "—Ä–µ—à–∏—Ç–∏–ª—ñ–≤–∫",
    "—Ä–µ—à–∏—Ç–∏–ª—ñ–≤–∫–∞",
    "—Ä–µ—à–∏—Ç–∏–ª—ñ–≤–∫–æ—é",
    "—Ä–µ—à–∏—Ç–∏–ª—ñ–≤–∫—É",
    "—Ä–µ—à–∏—Ç–∏–ª—ñ–≤–∫—ñ"
  ],
  "—Ä—ñ–≤–Ω–µ": [
    "—Ä—ñ–≤–Ω–µ",
    "—Ä—ñ–≤–Ω–µ–∞",
    "—Ä—ñ–≤–Ω–µ–µ",
    "—Ä—ñ–≤–Ω–µ–æ–º",
    "—Ä—ñ–≤–Ω–µ—É"
  ],
  "—Å–ª–æ–≤'—è–Ω–∫–∞": [
    "—Å–ª–æ–≤'—è–Ω–∫",
    "—Å–ª–æ–≤'—è–Ω–∫–∞",
    "—Å–ª–æ–≤'—è–Ω–∫–æ—é",
    "—Å–ª–æ–≤'—è–Ω–∫—É",
    "—Å–ª–æ–≤'—è–Ω–∫—ñ"
  ],
  "—Å–ª–æ–≤'—è–Ω—Å—å–∫": [
    "—Å–ª–æ–≤'—è–Ω—Å—å–∫",
    "—Å–ª–æ–≤'—è–Ω—Å—å–∫–∞",
    "—Å–ª–æ–≤'—è–Ω—Å—å–∫–µ",
    "—Å–ª–æ–≤'—è–Ω—Å—å–∫–æ–º",
    "—Å–ª–æ–≤'—è–Ω—Å—å–∫—É"
  ],
  "—Å–ª–æ–≤‚Äô—è–Ω—Å—å–∫": [
    "—Å–ª–æ–≤‚Äô—è–Ω—Å—å–∫",
    "—Å–ª–æ–≤‚Äô—è–Ω—Å—å–∫–∞",
    "—Å–ª–æ–≤‚Äô—è–Ω—Å—å–∫–µ",
    "—Å–ª–æ–≤‚Äô—è–Ω—Å—å–∫–æ–º",
    "—Å–ª–æ–≤‚Äô—è–Ω—Å—å–∫—É"
  ],
  "—Å–º–æ–ª—ñ–Ω–µ": [
    "—Å–º–æ–ª—ñ–Ω–µ",
    "—Å–º–æ–ª—ñ–Ω–µ–∞",
    "—Å–º–æ–ª—ñ–Ω–µ–µ",
    "—Å–º–æ–ª—ñ–Ω–µ–æ–º",
    "—Å–º–æ–ª—ñ–Ω–µ—É"
  ],
  "—Å–º—ñ–ª–∞": [
    "—Å–º—ñ–ª",
    "—Å–º—ñ–ª–∞",
    "—Å–º—ñ–ª–æ—é",
    "—Å–º—ñ–ª—É",
    "—Å–º—ñ–ª—ñ"
  ],
  "—Å—É–º–∏": [
    "—Å—É–º–∏",
    "—Å—É–º–∏–∞",
    "—Å—É–º–∏–µ",
    "—Å—É–º–∏–æ–º",
    "—Å—É–º–∏—É"
  ],
  "—Ç–µ—Ä–Ω–æ–ø—ñ–ª—å": [
    "—Ç–µ—Ä–Ω–æ–ø—ñ–ª—å",
    "—Ç–µ—Ä–Ω–æ–ø—ñ–ª—å–∞",
    "—Ç–µ—Ä–Ω–æ–ø—ñ–ª—å–µ",
    "—Ç–µ—Ä–Ω–æ–ø—ñ–ª—å–æ–º",
    "—Ç–µ—Ä–Ω–æ–ø—ñ–ª—å—É"
  ],
  "—É–º–∞–Ω—å": [
    "—É–º–∞–Ω—å",
    "—É–º–∞–Ω—å–∞",
    "—É–º–∞–Ω—å–µ",
    "—É–º–∞–Ω—å–æ–º",
    "—É–º–∞–Ω—å—É"
  ],
  "—Ö–∞—Ä–∫—ñ–≤": [
    "—Ö–∞—Ä–∫—ñ–≤",
    "—Ö–∞—Ä–∫—ñ–≤–∞",
    "—Ö–∞—Ä–∫—ñ–≤–µ",
    "—Ö–∞—Ä–∫—ñ–≤–æ–º",
    "—Ö–∞—Ä–∫—ñ–≤—É"
  ],
  "—Ö–º–µ–ª—å–Ω–∏—Ü—å–∫–∏–π": [
    "—Ö–º–µ–ª—å–Ω–∏—Ü—å–∫–∏–π",
    "—Ö–º–µ–ª—å–Ω–∏—Ü—å–∫–∏–π–∞",
    "—Ö–º–µ–ª—å–Ω–∏—Ü—å–∫–∏–π–µ",
    "—Ö–º–µ–ª—å–Ω–∏—Ü—å–∫–∏–π–æ–º",
    "—Ö–º–µ–ª—å–Ω–∏—Ü—å–∫–∏–π—É"
  ],
  "—Ö–º–µ–ª—å–æ–≤–µ": [
    "—Ö–º–µ–ª—å–æ–≤–µ",
    "—Ö–º–µ–ª—å–æ–≤–µ–∞",
    "—Ö–º–µ–ª—å–æ–≤–µ–µ",
    "—Ö–º–µ–ª—å–æ–≤–µ–æ–º",
    "—Ö–º–µ–ª—å–æ–≤–µ—É"
  ],
  "—Ö–æ—Ä–æ–ª": [
    "—Ö–æ—Ä–æ–ª",
    "—Ö–æ—Ä–æ–ª–∞",
    "—Ö–æ—Ä–æ–ª–µ",
    "—Ö–æ—Ä–æ–ª–æ–º",
    "—Ö–æ—Ä–æ–ª—É"
  ],
  "—á–µ—Ä–∫–∞—Å–∏": [
    "—á–µ—Ä–∫–∞—Å–∏",
    "—á–µ—Ä–∫–∞—Å–∏–∞",
    "—á–µ—Ä–∫–∞—Å–∏–µ",
    "—á–µ—Ä–∫–∞—Å–∏–æ–º",
    "—á–µ—Ä–∫–∞—Å–∏—É"
  ],
  "—ñ–∑—é–º": [
    "—ñ–∑—é–º",
    "—ñ–∑—é–º–∞",
    "—ñ–∑—é–º–µ",
    "—ñ–∑—é–º–æ–º",
    "—ñ–∑—é–º—É"
  ]
}

city_aliases = {
    "–¥–Ω–µ–ø—Ä": "–¥–Ω—ñ–ø—Ä–æ", "—É–º–∞–Ω—å": "—É–º–∞–Ω—å", "–ª—å–≤–æ–≤": "–ª—å–≤—ñ–≤", "–≤–∏–Ω–Ω–∏—Ü–∞": "–≤—ñ–Ω–Ω–∏—Ü—è",
    "–∫—Ä–æ–ø–∏–≤–Ω–∏—Ü–∫–∏–π": "–∫—Ä–æ–ø–∏–≤–Ω–∏—Ü—å–∫–∏–π", "–¥–æ–±—Ä–æ–ø–æ–ª—å–µ": "–¥–æ–±—Ä–æ–ø—ñ–ª–ª—è", "–∫—Ä–∞–º–∞—Ç–æ—Ä—Å–∫": "–∫—Ä–∞–º–∞—Ç–æ—Ä—Å—å–∫",
    "—Å–ª–æ–≤—è–Ω—Å–∫": "—Å–ª–æ–≤‚Äô—è–Ω—Å—å–∫", "—Å–ª–∞–≤—è–Ω—Å–∫": "—Å–ª–æ–≤‚Äô—è–Ω—Å—å–∫", "—á–µ—Ä–∫–∞—Å—Å": "—á–µ—Ä–∫–∞—Å–∏", "–ø–∞–≤–ª–æ–≥—Ä–∞–ª": "–ø–∞–≤–ª–æ–≥—Ä–∞–¥", "–¥–Ω–µ–ø—Ä–æ–ø–µ—Ç—Ä–æ–≤—Å–∫": "–¥–Ω—ñ–ø—Ä–æ", "–∫–∏—Ä–æ–≤–æ–≥—Ä–∞–¥": "–∫—Ä–æ–ø–∏–≤–Ω–∏—Ü—å–∫–∏–π", "–∫—ñ—Ä–æ–≤–æ–≥—Ä–∞–¥": "–∫—Ä–æ–ø–∏–≤–Ω–∏—Ü—å–∫–∏–π"
}

last_session = {}

def normalize(text):
    text = re.sub(r"[‚Äô']", "", text.lower()).strip()
    return re.sub(r"\s+", " ", text)

def match_city(word):
    norm = normalize(word)
    for base, forms in CITY_FORMS.items():
        if norm in forms:
            return base
    # —è–∫—â–æ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ ‚Äî fuzzy
    result = process.extractOne(norm, list(CITY_FORMS.keys()))
    return result[0] if result and result[1] >= 75 else None

def extract_two_cities(text):
    words = normalize(text).split()
    found = []
    for word in words:
        city = match_city(word)
        if city and city not in found:
            found.append(city)
    return found[:2]

def route_link(start, end):
    return f"https://bus-timel.com.ua/routes/{start.replace(' ', '-')}-{end.replace(' ', '-')}.html"

def find_real_route(start, end):
    for route in routes:
        all_points = [route["start"]] + [s["city"] for s in route.get("stops", [])] + [route["end"]]
        if start in all_points and end in all_points and all_points.index(start) < all_points.index(end):
            return route, all_points
    return None, []

def extract_price(route, end):
    if route["end"].lower() == end:
        return route.get("price")
    for s in route.get("stops", []):
        if s["city"].lower() == end and s.get("price", "").replace(" ", "").isdigit():
            return s["price"]
    return None

@app.route("/chat", methods=["POST"])
def chat():
    data = request.json
    msg_raw = data.get("message", "")
    session_id = data.get("session_id", "default")
    msg = normalize(msg_raw)

    if session_id not in last_session:
        last_session[session_id] = {"greeted": False, "confirm": None}

    session = last_session[session_id]

    if not session["greeted"]:
        session["greeted"] = True
        return jsonify({"reply": "–í—ñ—Ç–∞—é! –Ø –¥–∏—Å–ø–µ—Ç—á–µ—Ä Bus-Timel. –ù–∞–ø–∏—à—ñ—Ç—å, –±—É–¥—å –ª–∞—Å–∫–∞, –∑–≤—ñ–¥–∫–∏ —ñ –∫—É–¥–∏ –≤–∏ —Ö–æ—á–µ—Ç–µ —ó—Ö–∞—Ç–∏."})

    if msg in ["—Ç–∞–∫", "–¥–∞"] and session["confirm"]:
        start, end = session["confirm"]
        session["confirm"] = None
        route, points = find_real_route(start, end)
        if route:
            i1 = points.index(start)
            i2 = points.index(end)
            i2 = points.index(end)
            price = extract_price(route, end) or "–£—Ç–æ—á–Ω—é–π—Ç–µ"
            link = route_link(start, end)
            reply = f"üöå <b>–ú–∞—Ä—à—Ä—É—Ç:</b> {start} ‚Üí {end}\n"
            reply += f"üí∞ <b>–¶—ñ–Ω–∞:</b> {price} –≥—Ä–Ω\n"
            reply += f"‚è≥ <b>–¢—Ä–∏–≤–∞–ª—ñ—Å—Ç—å:</b> {route.get('duration', '‚Äî')}\n"
            if route.get("departure_times"):
                reply += f"‚è∞ <b>–í—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–Ω—è:</b> {route['departure_times'][0]}\n"
            if route.get("arrival_times"):
                reply += f"üïì <b>–ü—Ä–∏–±—É—Ç—Ç—è:</b> {route['arrival_times'][0]}\n"
            if i2 > i1 + 1:
                reply += "üó∫Ô∏è <b>–ó—É–ø–∏–Ω–∫–∏:</b> " + " ‚Üí ".join(points[i1+1:i2]) + "\n"
            reply += f"üîó <a href='{link}'>–ü–µ—Ä–µ–≥–ª—è–Ω—É—Ç–∏ –º–∞—Ä—à—Ä—É—Ç</a>\nüìù <a href='{link}'>–ó–∞–±—Ä–æ–Ω—é–≤–∞—Ç–∏ –º—ñ—Å—Ü–µ</a>"
            return jsonify({"reply": reply, "html": True})
        else:
            return jsonify({"reply": "–ú–∞—Ä—à—Ä—É—Ç –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ. –£—Ç–æ—á–Ω—ñ—Ç—å, –±—É–¥—å –ª–∞—Å–∫–∞, —â–µ —Ä–∞–∑."})

    if msg in ["–Ω—ñ", "–Ω–µ—Ç", "–Ω–∞–æ–±–æ—Ä–æ—Ç", "–≤ –æ–±—Ä–∞—Ç–Ω–æ–º –Ω–∞–ø—Ä—è–º–∫—É", "–≤ –æ–±—Ä–∞—Ç–Ω–æ–º –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–∏"] and session["confirm"]:
        s, e = session["confirm"]
        session["confirm"] = (e, s)
        return jsonify({"reply": f"–¢–æ–¥—ñ, –º–æ–∂–ª–∏–≤–æ, –∑ {e} –¥–æ {s}?", "confirm": {"start": e, "end": s}})

    cities = extract_two_cities(msg)
    if len(cities) == 2:
        session["confirm"] = (cities[0], cities[1])
        return jsonify({
            "reply": f"–í–∏ –º–∞—î—Ç–µ –Ω–∞ —É–≤–∞–∑—ñ –∑ {cities[0].capitalize()} –¥–æ {cities[1].capitalize()}?",
            "confirm": {"start": cities[0], "end": cities[1]}
        })
    elif len(cities) == 1:
        return jsonify({"reply": f"–ó —è–∫–æ–≥–æ –º—ñ—Å—Ç–∞ –≤–∏ —Ö–æ—á–µ—Ç–µ —ó—Ö–∞—Ç–∏ –¥–æ {cities[0].capitalize()}?"})
    else:
        return jsonify({"reply": "–ù–∞–ø–∏—à—ñ—Ç—å, –±—É–¥—å –ª–∞—Å–∫–∞, –∑ —è–∫–æ–≥–æ –º—ñ—Å—Ç–∞ —ñ –∫—É–¥–∏ –≤–∏ —Ö–æ—á–µ—Ç–µ —ó—Ö–∞—Ç–∏."})

@app.route("/")
def index():
    return "Bus-Timel Declension Bot"

if __name__ == "__main__":
    port = int(os.environ.get("PORT", 5000))
    app.run(host="0.0.0.0", port=port)
